name: Build Android APK

on:
  push:
    branches: [ master ]
    paths:
      - 'mood_music_app/**'
      - '.github/workflows/build-apk.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'

    - name: Create Flutter project structure
      run: |
        flutter create --org com.moodmusic --project-name mood_music_app mood_music_app_build

    - name: Copy source code and Android config
      run: |
        cp -r mood_music_app/lib/* mood_music_app_build/lib/
        cp mood_music_app/pubspec.yaml mood_music_app_build/
        cp -r mood_music_app/android/* mood_music_app_build/android/

    - name: Get dependencies
      run: |
        cd mood_music_app_build
        flutter pub get

    - name: Build APK
      run: |
        cd mood_music_app_build
        flutter build apk --release --split-per-abi

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: mood_music_app_build/build/app/outputs/flutter-apk/*.apk

    - name: Create Release
      if: github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ğŸµ å¿ƒæƒ…éŸ³ä¹ç”Ÿæˆå™¨ Android åº”ç”¨

          è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ v1.0.${{ github.run_number }}

          ### å®‰è£…è¯´æ˜
          - ä¸‹è½½é€‚åˆä½ è®¾å¤‡çš„ APK æ–‡ä»¶
          - `app-arm64-v8a-release.apk` - é€‚ç”¨äºå¤§å¤šæ•°æ–°è®¾å¤‡ï¼ˆæ¨èï¼‰
          - `app-armeabi-v7a-release.apk` - é€‚ç”¨äºè¾ƒæ—§çš„è®¾å¤‡
          - `app-x86_64-release.apk` - é€‚ç”¨äºæ¨¡æ‹Ÿå™¨

          ### ä½¿ç”¨æ–¹æ³•
          1. å®‰è£… APK åˆ° Android è®¾å¤‡
          2. æ‰“å¼€åº”ç”¨å¹¶è¾“å…¥ MiniMax API Key
          3. æè¿°ä½ çš„å¿ƒæƒ…æˆ–é€‰æ‹©å¿«æ·é€‰é¡¹
          4. ç‚¹å‡»ç”ŸæˆéŸ³ä¹å¹¶ç­‰å¾…
          5. æ’­æ”¾ã€åˆ†äº«æˆ–é‡æ–°ç”Ÿæˆ

          ğŸ¤– è‡ªåŠ¨æ„å»ºäº GitHub Actions
        files: |
          mood_music_app_build/build/app/outputs/flutter-apk/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
